name: Release

on:
  workflow_dispatch:
    inputs:
      version_bump:
        description: 'Version bump type'
        required: true
        type: choice
        options:
          - Major
          - Minor
          - Patch

jobs:
  release:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pages: write
      id-token: write

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Bump version
        id: bump
        run: |
          set -euo pipefail
          CURRENT=$(grep -m1 '^version\s*=' blender_manifest.toml | sed 's/^version\s*=\s*"\(.*\)".*/\1/')
          if [ -z "$CURRENT" ]; then
            echo "Error: version not found in blender_manifest.toml" >&2
            exit 1
          fi
          IFS='.' read -r MAJOR MINOR PATCH <<< "$CURRENT"
          BUMP="${{ github.event.inputs.version_bump }}"
          if [ "$BUMP" = "Major" ]; then
            MAJOR=$((MAJOR + 1)); MINOR=0; PATCH=0
          elif [ "$BUMP" = "Minor" ]; then
            MINOR=$((MINOR + 1)); PATCH=0
          else
            PATCH=$((PATCH + 1))
          fi
          NEW_VERSION="$MAJOR.$MINOR.$PATCH"
          sed -i "s/^version = \".*\"/version = \"$NEW_VERSION\"/" blender_manifest.toml
          echo "new_version=$NEW_VERSION" >> "$GITHUB_OUTPUT"

      - name: Commit version bump
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add blender_manifest.toml
          git diff --cached --quiet || git commit -m "chore: bump version to ${{ steps.bump.outputs.new_version }}"
          git push

      - name: Get version
        id: version
        run: |
          set -euo pipefail
          VERSION=$(grep -m1 '^version\s*=' blender_manifest.toml | sed 's/^version\s*=\s*"\(.*\)".*/\1/')
          if [ -z "$VERSION" ]; then
            echo "Error: VERSION not found in blender_manifest.toml" >&2
            exit 1
          fi
          echo "version=$VERSION" >> "$GITHUB_OUTPUT"

      - name: Create zip
        run: |
          ZIP_NAME="dnd_tile_forge-${{ steps.version.outputs.version }}.zip"
          zip -r "$ZIP_NAME" \
            *.py \
            blender_manifest.toml \
            -x "__pycache__/*"

      - name: Generate index.json
        run: |
          python3 << 'PYEOF'
          import hashlib, json, os, tomllib

          with open("blender_manifest.toml", "rb") as f:
              manifest = tomllib.load(f)

          version = manifest["version"]
          zip_name = f"dnd_tile_forge-{version}.zip"

          with open(zip_name, "rb") as f:
              zip_bytes = f.read()
          archive_size = len(zip_bytes)
          archive_hash = "sha256:" + hashlib.sha256(zip_bytes).hexdigest()

          entry = {
              "schema_version": manifest["schema_version"],
              "id": manifest["id"],
              "version": version,
              "name": manifest["name"],
              "tagline": manifest["tagline"],
              "maintainer": manifest["maintainer"],
              "type": manifest["type"],
              "license": manifest["license"],
              "blender_version_min": manifest["blender_version_min"],
              "tags": manifest["tags"],
              "permissions": manifest.get("permissions", {}),
              "archive_url": f"./{zip_name}",
              "archive_size": archive_size,
              "archive_hash": archive_hash,
          }

          index = {
              "version": "v1",
              "blocklist": [],
              "data": [entry],
          }

          os.makedirs("pages", exist_ok=True)
          with open("pages/index.json", "w") as f:
              json.dump(index, f, indent=2)

          # Copy zip into pages directory
          import shutil
          shutil.copy(zip_name, "pages/")

          print(f"Built index.json for {manifest['name']} v{version}")
          print(f"  archive_size: {archive_size}")
          print(f"  archive_hash: {archive_hash}")
          PYEOF

      - name: Deploy to GitHub Pages
        uses: peaceiris/actions-gh-pages@v4
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          publish_dir: ./pages
          force_orphan: true

      - name: Create release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: v${{ steps.version.outputs.version }}
          name: v${{ steps.version.outputs.version }}
          files: dnd_tile_forge-${{ steps.version.outputs.version }}.zip
          make_latest: true
